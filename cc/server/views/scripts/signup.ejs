<script>
	const AUTH_TOKEN_KEY = 'VERSION[0021].Main';

	async function getProfileInfo(token) {
		// http://localhost:8005/v1/users/profile/me/
		const response = await fetch("/v1/users/profile/me", {
			method: 'GET',
			headers: {
				'Content-Type': 'application/json',
				'Accept': 'application/json',
				'Authorization': `Bearer ${token}`
			},
		})
			.then(res => {
				if (!res.ok) {
					window.alert("Error getting profile info")
					return
				}
				return res.json()
			})

		const data = response.data;
		return data;
	}

	const login = async (formData) => {
		const response = await fetch("/web/api/auth/login", {
			method: "POST",
			headers: {
				'Content-Type': 'application/json',
				'Accept': 'application/json',
			},
			body: JSON.stringify(formData),
		}).then(res => {
			if (!res.ok) {
				window.alert("Error signing in")
				return
			}
			return res.json();

		})

		const authToken = response.data.access_token;
		const userInfo = await getProfileInfo(authToken);
		userInfo["token"] = authToken
		storeAuthJsonInfo(userInfo);
	}

	const createModal = (modalRef, openModalBtnRef) => {
		const modal = document.querySelector(modalRef);
		const openModalBtn = document.querySelector(openModalBtnRef);
		const closeModalSpan = modal.querySelector('.close');

		openModalBtn.onclick = function () {
			modal.style.display = 'block';
		};

		closeModalSpan.onclick = function () {
			modal.style.display = 'none';
		};

		window.onclick = function (event) {
			if (event.target == modal) {
				modal.style.display = 'none';
			}
		};
		return modal
	};

	function storeAuthJsonInfo(userInfo) {
		const data = {
			user: {...userInfo.user,
				token: userInfo.token,
				firstName: userInfo.first_name,
				lastName: userInfo.last_name
			},
			simulation: {
				speed: 1,
				window: 1,
				type: "SYNCHRONOUS"
			},
			globalViews: [],
			joyRideStepsCompleted: []
		}
		window.localStorage.setItem(AUTH_TOKEN_KEY, JSON.stringify(data));
	}

	async function logout() {
		const response = await fetch("/web/api/auth/logout", {
			method: 'POST'
		});
		if (response.ok) {
			document.cookie = `transfer-auth-token=; max-age=-1;`;
			document.cookie = `connect.sid=; max-age=-1;`;
			window.localStorage.removeItem(AUTH_TOKEN_KEY);
			window.location.reload()
		} else {
			// TODO: Error Logging Out, show something.
		}
	}
	
	<% if (!data.user) { %>
		// const signInModal = createModal('#signInDialog', '#signInDialogBtn');
		const signInModal = document.querySelector('#signInDialog');

		const signInForm = document.getElementsByClassName("sigin-form")[0];
		signInForm.addEventListener("submit", async function (event) {
			event.preventDefault();
			const formData = new FormData(this);
			const payload = {}
			for (let [key, value] of formData.entries()) {
				payload[`${key}`] = value
			}
			
			try {
				await login(payload);
				console.log('submitting form....');
				// close the modal
				signInModal.style.display = "none";
				window.location.reload();
			} catch (error) {
				console.error('Error signing in:', error);
			}
		})
			<% } %>

</script>