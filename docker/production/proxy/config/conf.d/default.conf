server {
  listen 3001 default;
 
  gzip on;
  gzip_types *;
  gzip_proxied any;

  client_max_body_size 128M;

	# 10 minutes
	proxy_read_timeout 600;
  proxy_connect_timeout 600;
  proxy_send_timeout 600;

	location / {
		root /build;
		index index.html;
		sendfile on;
		# add_header Pragma "no-cache";
		# rewrite ^/research/dashboard/?$ /research-dashboard/ redirect;
		try_files $uri $uri/ =404;
	}

	location ~* ^/((dashboard|model|admin|login)(/)?.*) {
		add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    return 302 https://$host/?x-route=$1;
  }

	# location ~ ^/cache/model_images(.*) {
	# 	root /cache/model_images;
	# 	sendfile on;
	# 	try_files $1 $1/ =404;
	# }

	location /web {
		proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_buffering off;
    proxy_pass http://web:5003;
	}

	location /cache {
		proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_buffering off;
    proxy_pass http://web:5003/web/cache;
	}

	location /research/dashboard/ {
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

    proxy_buffering off;

    proxy_pass http://web:5003/web/research/dashboard/;
  }
	location /logger/ {
		# if ($request_method = POST) {
        # return 405;
    # }
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

    proxy_buffering off;

    proxy_pass http://logger:8085/;
  }
	location /socket.io/ {
    proxy_pass http://web:5003;
    proxy_redirect     off;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection "upgrade";
  }
  location ~ ^/(metrics|institutional-onboarding) {
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

    proxy_buffering off;

    proxy_pass http://web:5003;
  }
  location ~* ^/(_api|api|metrics|institutional-onboarding)/ {
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

    proxy_buffering off;

    proxy_pass http://web:5003;
  }
	location /v1 {
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

    proxy_buffering off;

    proxy_pass http://ccapp:8005/v1;
  }

	# ===============================================
	# WebSocket proxy for Django Channels (ccapp)
	# This forwards /ws/* requests to the ASGI server
	# ===============================================
	location /ws {
    proxy_pass http://ccapp:8005/ws;
    proxy_redirect     off;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
		proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header   Upgrade $http_upgrade;
		proxy_set_header   Connection "upgrade";
  }
}
